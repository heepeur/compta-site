<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compta Chirurgie</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 2em 1em;
      max-width: 850px;
      margin-left: auto;
      margin-right: auto;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 1.5em;
      font-size: 2em;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid #ccc;
      margin-bottom: 1em;
      background: #fff;
      border-radius: 8px 8px 0 0;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }
    .tab {
      flex: 1;
      padding: 1em;
      text-align: center;
      background: #f7f7f7;
      color: #555;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .tab:hover:not(.active) {
      background: #e6e6e6;
    }
    .tab.active {
      background: #ffffff;
      color: #0077cc;
      border-bottom: 2px solid #ffffff;
    }
    .tab-content {
      display: none;
      background: #fff;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      padding: 1.5em;
      border: 1px solid #ddd;
    }
    .tab-content.active {
      display: block;
    }
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
    }
    form input, form select {
      flex: 1 1 200px;
      padding: 0.7em;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fefefe;
      transition: border-color 0.3s;
    }
    form input:focus, form select:focus {
      outline: none;
      border-color: #0077cc;
    }
    form button {
      flex: 1 1 100%;
      padding: 0.8em;
      font-size: 1.1em;
      background: #0077cc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    form button:hover {
      background: #005fa3;
    }
    #cancelEditBtn {
      background: #e74c3c;
      display: none;
    }
    #cancelEditBtn:hover {
      background: #c0392b;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      font-size: 0.95em;
      border-radius: 6px;
      overflow: hidden;
    }
    th, td {
      padding: 0.75em 1em;
      text-align: center;
    }
    th {
      background: #0077cc;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .actions {
      display: flex;
      gap: 0.5em;
      justify-content: center;
    }
    .btn {
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1.2em;
    }
    .btn.edit {
      color: #0077cc;
    }
    .btn.edit:hover {
      color: #005fa3;
    }
    .btn.delete {
      color: #e74c3c;
    }
    .btn.delete:hover {
      color: #c0392b;
    }
    #totalRecettes {
      margin-top: 1.5em;
      font-weight: bold;
      font-size: 1.1em;
      text-align: right;
      color: #0077cc;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Compta Chirurgie</h1>

<div class="tabs">
  <div class="tab active" data-tab="saisie">Saisie</div>
  <div class="tab" data-tab="tableau">Tableau</div>
</div>

<div id="saisie" class="tab-content active">
  <form id="entryForm">
    <input type="date" id="date" required />
    <input type="text" id="description" placeholder="Description" required />
    <input type="number" id="montant" placeholder="Montant" step="0.01" required />
    <select id="type" required>
      <option value="">Type</option>
      <option value="Recette">Recette</option>
      <option value="D√©pense">D√©pense</option>
    </select>
    <button type="submit" id="submitBtn">Ajouter</button>
    <button type="button" id="cancelEditBtn">Annuler</button>
  </form>
</div>

<div id="tableau" class="tab-content">
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Description</th>
        <th>Montant</th>
        <th>Type</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="entriesTableBody"></tbody>
  </table>
  <div id="totalRecettes">Total Recettes : 0.00 $</div>
  <canvas id="recetteChart" height="100" style="margin-top: 2em;"></canvas>
  <div style="text-align: right; margin-top: 0.5em;">
    <button id="toggleChartModeBtn" style="background:#ddd;border:none;padding:0.5em 1em;border-radius:6px;cursor:pointer;">
      üóì Voir par mois
    </button>
  </div>
</div>

<script>
let recetteChart = null;
let groupBy = 'day';

const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const target = tab.dataset.tab;
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    tabContents.forEach(tc => tc.classList.toggle('active', tc.id === target));
  });
});

document.getElementById('toggleChartModeBtn').addEventListener('click', () => {
  groupBy = groupBy === 'day' ? 'month' : 'day';
  updateRecetteChart();
  document.getElementById('toggleChartModeBtn').textContent =
    groupBy === 'day' ? 'üóì Voir par mois' : 'üìÖ Voir par jour';
});

let entries = [];
let editIndex = -1;

const entryForm = document.getElementById('entryForm');
const dateInput = document.getElementById('date');
const descriptionInput = document.getElementById('description');
const montantInput = document.getElementById('montant');
const typeSelect = document.getElementById('type');
const submitBtn = document.getElementById('submitBtn');
const cancelEditBtn = document.getElementById('cancelEditBtn');
const entriesTableBody = document.getElementById('entriesTableBody');
const totalRecettesDiv = document.getElementById('totalRecettes');

function updateRecetteChart() {
  const recettes = entries.filter(e => e.type === 'Recette');
  if (recettes.length === 0) {
    if (recetteChart) recetteChart.destroy();
    return;
  }
  const grouped = {};
  recettes.forEach(e => {
    const key = groupBy === 'day' ? e.date : e.date.slice(0, 7);
    if (!grouped[key]) grouped[key] = 0;
    grouped[key] += parseFloat(e.montant);
  });
  const labels = Object.keys(grouped).sort();
  const data = labels.map(l => grouped[l]);
  const moyenne = data.reduce((a, b) => a + b, 0) / data.length;
  const moyenneLine = Array(labels.length).fill(moyenne);
  const ctx = document.getElementById('recetteChart').getContext('2d');
  if (recetteChart) recetteChart.destroy();
  recetteChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: groupBy === 'day' ? 'Recettes par jour ($)' : 'Recettes par mois ($)',
          data,
          borderColor: '#0077cc',
          backgroundColor: '#0077cc',
          tension: 0.3,
          pointRadius: 4,
          pointBackgroundColor: '#0077cc',
          fill: false
        },
        {
          label: 'Moyenne ($)',
          data: moyenneLine,
          borderColor: '#888',
          borderDash: [5, 5],
          pointRadius: 0,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => val + ' $'
          }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: '#333',
            font: { size: 13 }
          }
        },
        tooltip: {
          callbacks: {
            label: context => context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' $'
          }
        }
      }
    }
  });
}

function loadEntries() {
  fetch('/api/entries')
    .then(res => res.json())
    .then(data => {
      entries = data;
      renderTable();
    });
}

function renderTable() {
  entriesTableBody.innerHTML = '';
  entries.forEach((entry, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${entry.date}</td>
      <td>${entry.description}</td>
      <td>${parseFloat(entry.montant).toFixed(2)} $</td>
      <td>${entry.type}</td>
      <td class="actions">
        <button class="btn edit" onclick="startEdit(${index})">‚úèÔ∏è</button>
        <button class="btn delete" onclick="deleteEntry(${index})">‚ùå</button>
      </td>`;
    entriesTableBody.appendChild(tr);
  });
  updateTotalRecettes();
  updateRecetteChart();
}

function updateTotalRecettes() {
  const total = entries
    .filter(e => e.type === 'Recette')
    .reduce((sum, e) => sum + parseFloat(e.montant), 0);
  totalRecettesDiv.textContent = `Total Recettes : ${total.toFixed(2)} $`;
}

entryForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const newEntry = {
    date: dateInput.value,
    description: descriptionInput.value.trim(),
    montant: parseFloat(montantInput.value),
    type: typeSelect.value
  };
  const method = editIndex === -1 ? 'POST' : 'PUT';
  const url = editIndex === -1 ? '/api/entries' : `/api/entries/${editIndex}`;
  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(newEntry)
  });
  if (!res.ok) return alert('Erreur sauvegarde');
  resetForm();
  await loadEntries();
  switchTab('tableau');
});

function startEdit(index) {
  const entry = entries[index];
  dateInput.value = entry.date;
  descriptionInput.value = entry.description;
  montantInput.value = entry.montant;
  typeSelect.value = entry.type;
  submitBtn.textContent = 'Modifier';
  cancelEditBtn.style.display = 'inline-block';
  editIndex = index;
  switchTab('saisie');
}

cancelEditBtn.addEventListener('click', resetForm);

function resetForm() {
  entryForm.reset();
  submitBtn.textContent = 'Ajouter';
  cancelEditBtn.style.display = 'none';
  editIndex = -1;
}

async function deleteEntry(index) {
  if (confirm('Supprimer cette entr√©e ?')) {
    const res = await fetch(`/api/entries/${index}`, {
      method: 'DELETE'
    });
    if (!res.ok) return alert('Erreur suppression');
    await loadEntries();
  }
}

function switchTab(tabName) {
  tabs.forEach(t => t.classList.remove('active'));
  tabContents.forEach(tc => tc.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
  document.getElementById(tabName).classList.add('active');
}

window.startEdit = startEdit;
window.deleteEntry = deleteEntry;
loadEntries();
</script>

</body>
</html>
